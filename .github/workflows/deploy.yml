name: CD - Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggers

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
      
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H -T 10 -p 2222 46.202.128.120 >> ~/.ssh/known_hosts || echo "ssh-keyscan failed, will use StrictHostKeyChecking=no"
      
      - name: Test SSH connection
        run: |
          ssh -p 2222 -o StrictHostKeyChecking=no pierre_sudo_user@46.202.128.120 'echo "âœ… SSH connection successful"'
      
      - name: Deploy to VPS
        run: |
          ssh -p 2222 -o StrictHostKeyChecking=no pierre_sudo_user@46.202.128.120 << 'ENDSSH'
            set -e

            echo "ðŸ“¦ Deploying to VPS..."
            cd /home/pierre_sudo_user/docker-apps

            # Store current commit before pull
            OLD_COMMIT=$(git rev-parse HEAD)

            # Force-sync to GitHub state (handles dirty trees, divergent history)
            echo "ðŸ”„ Syncing VPS to GitHub..."
            git fetch origin main
            git reset --hard origin/main

            NEW_COMMIT=$(git rev-parse HEAD)

            # Update submodules if they exist
            if [ -f .gitmodules ]; then
              echo "ðŸ”„ Updating submodules..."
              git submodule update --init --recursive || echo "âš ï¸ Submodule update skipped"
            fi

            # Detect which services changed
            echo "ðŸ” Detecting changed services..."
            CHANGED_FILES=$(git diff --name-only $OLD_COMMIT $NEW_COMMIT)
            echo "Changed files:"
            echo "$CHANGED_FILES"

            SERVICES_TO_BUILD=""
            SERVICES_TO_RESTART=""
            for file in $CHANGED_FILES; do
              case "$file" in
                # More specific patterns first (nested directories)
                chonkie/chonkie-visualizer/*) SERVICES_TO_BUILD="$SERVICES_TO_BUILD chonkie-visualizer" ;;
                # Then general patterns
                chonkie/*) SERVICES_TO_BUILD="$SERVICES_TO_BUILD chonkie" ;;
                graphiti/*) SERVICES_TO_BUILD="$SERVICES_TO_BUILD graphiti" ;;
                deepeval/*) SERVICES_TO_BUILD="$SERVICES_TO_BUILD deepeval" ;;
                personal-website/*) SERVICES_TO_BUILD="$SERVICES_TO_BUILD personal-website" ;;
                reading-fluency/*) SERVICES_TO_BUILD="$SERVICES_TO_BUILD reading-fluency" ;;
                nginx/*) SERVICES_TO_RESTART="$SERVICES_TO_RESTART nginx" ;;
                monitoring/prometheus/*) SERVICES_TO_RESTART="$SERVICES_TO_RESTART prometheus" ;;
                monitoring/grafana/*) SERVICES_TO_RESTART="$SERVICES_TO_RESTART grafana" ;;
                docker-compose.yml|.env*) SERVICES_TO_BUILD="ALL" ;;
              esac
            done

            # Remove duplicates
            SERVICES_TO_BUILD=$(echo "$SERVICES_TO_BUILD" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
            SERVICES_TO_RESTART=$(echo "$SERVICES_TO_RESTART" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)

            if [ -z "$SERVICES_TO_BUILD" ] && [ -z "$SERVICES_TO_RESTART" ]; then
              echo "â„¹ï¸ No service directories changed. Only infrastructure files updated."
              echo "ðŸ”„ Restarting all services without rebuild..."
              docker compose up -d
            elif [ "$SERVICES_TO_BUILD" = "ALL" ]; then
              echo "ðŸ—ï¸ docker-compose.yml or .env changed - rebuilding all services..."
              docker container prune -f
              docker compose up -d --build --remove-orphans
            else
              docker container prune -f

              # Rebuild services that need building (have Dockerfiles)
              if [ -n "$SERVICES_TO_BUILD" ]; then
                echo "ðŸ—ï¸ Building services: $SERVICES_TO_BUILD"
                for service in $SERVICES_TO_BUILD; do
                  echo "  â†’ Building $service..."
                  docker compose up -d --build --no-deps $service
                done
              fi

              # Restart services that use volume mounts (no build needed)
              if [ -n "$SERVICES_TO_RESTART" ]; then
                echo "ðŸ”„ Restarting services: $SERVICES_TO_RESTART"
                for service in $SERVICES_TO_RESTART; do
                  echo "  â†’ Restarting $service..."
                  docker compose up -d --force-recreate --no-deps $service
                done
              fi
            fi

            # Wait for services to stabilize
            sleep 5

            # Clean up unused images to save disk space
            echo "ðŸ§¹ Cleaning up unused images..."
            docker image prune -f

            # Show status
            echo ""
            echo "ðŸ“Š Service Status:"
            docker compose ps

            echo ""
            echo "âœ… Deployment complete!"
          ENDSSH
      
      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying services are running..."
          ssh -p 2222 -o StrictHostKeyChecking=no pierre_sudo_user@46.202.128.120 'cd /home/pierre_sudo_user/docker-apps && docker compose ps --format "table {{.Service}}\t{{.Status}}"'
      
      - name: Deployment summary
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Site: https://pierre.brandiron.co.za"
