name: CI - Testing & Linting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-docker:
    name: Validate Docker Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.GH_PAT }}
      
      - name: Create dummy env files for validation
        run: |
          # Create ALL missing .env and .env.local files that docker-compose references
          touch .env || true
          touch chonkie/.env.local || true
          touch lightrag/.env.local || true
          touch graphiti/.env.local || true
          touch personal-website/.env || true
          touch personal-website/.env.local || true
          touch reading-fluency/.env || true
      
      - name: Validate docker-compose.yml
        run: |
          docker compose config -q
          echo "✅ docker-compose.yml is valid"
      
      - name: Check for common Docker issues
        run: |
          # Check for exposed ports conflicts
          if grep -q "ports:" docker-compose.yml; then
            echo "✅ Port mappings found"
          fi
          
          # Check for networks
          if grep -q "networks:" docker-compose.yml; then
            echo "✅ Networks configured"
          fi
          
          # Check for volumes
          if grep -q "volumes:" docker-compose.yml; then
            echo "✅ Volumes configured"
          fi

  lint-scripts:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: error
        continue-on-error: true

  website-build:
    name: Build & Lint Website
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.GH_PAT }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: personal-website/package-lock.json
      
      - name: Install dependencies
        working-directory: ./personal-website
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./personal-website
        run: npm run lint || echo "⚠️ Linting warnings (non-blocking)"
        continue-on-error: true
      
      - name: Build website
        working-directory: ./personal-website
        run: npm run build
      
      - name: Check build artifacts
        working-directory: ./personal-website
        run: |
          if [ -d "dist" ]; then
            echo "✅ Build successful - dist folder created"
            ls -lh dist/
          else
            echo "❌ Build failed - no dist folder"
            exit 1
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-docker, lint-scripts, website-build]
    if: always()
    
    steps:
      - name: Check all jobs status
        run: |
          echo "Docker validation: ${{ needs.validate-docker.result }}"
          echo "Script linting: ${{ needs.lint-scripts.result }}"
          echo "Website build: ${{ needs.website-build.result }}"
          
          if [[ "${{ needs.validate-docker.result }}" == "success" && \
                "${{ needs.website-build.result }}" == "success" ]]; then
            echo "✅ Core CI checks passed!"
            exit 0
          else
            echo "❌ Some CI checks failed"
            exit 1
          fi
