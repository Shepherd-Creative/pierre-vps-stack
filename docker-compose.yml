services:
  # ===========================================
  # nginx
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/html:/usr/share/nginx/html
      - ./nginx/auth:/etc/nginx/auth
      - ./nginx/scripts/docker-entrypoint.sh:/docker-entrypoint.sh:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    environment:
      - N8N_CHAT_WEBHOOK_UUID=${N8N_CHAT_WEBHOOK_UUID}
      - N8N_CHAT_AUTH_BASE64=${N8N_CHAT_AUTH_BASE64}
    entrypoint: ["/docker-entrypoint.sh"]
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - DAC_OVERRIDE
      - SETUID
      - SETGID
    tmpfs:
      - /var/cache/nginx:size=128m
      - /run:size=1m
      - /tmp:size=64m
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:80/ || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
        reservations:
          memory: 64M
          cpus: '0.05'
    networks:
      - docker-apps-network

  # ===========================================
  # n8n
  # ===========================================
  n8n:
    image: n8nio/n8n:1.121.3
    container_name: n8n
    restart: unless-stopped
    user: "node"
    env_file:
      - .env
    volumes:
      - n8n-data:/home/node/.n8n
    expose:
      - 5678
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
      - /home/node/.cache:size=256m,uid=1000,gid=1000
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:5678/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 800M
          cpus: '0.6'
        reservations:
          memory: 400M
          cpus: '0.1'
    networks:
      - docker-apps-network

  # ===========================================
  # Certbot - only runs manually for certificate renewal
  # ===========================================
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'certbot renew'"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    profiles:
      - certbot-renew  # Only runs with: docker compose --profile certbot-renew run certbot

  # ===========================================
  # Neo4j Database for LightRAG and Graphiti
  # ===========================================
  neo4j:
    image: neo4j:5.26.2
    container_name: neo4j
    restart: unless-stopped
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-CHANGE_ME_NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_dbms_memory_heap_initial__size=768M
      - NEO4J_dbms_memory_heap_max__size=1536M
      - NEO4J_dbms_memory_pagecache_size=512M
      - NEO4J_dbms_connector_bolt_listen__address=0.0.0.0:7687
      - NEO4J_dbms_connector_http_listen__address=0.0.0.0:7474
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    expose:
      - 7474
      - 7687
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETUID
      - SETGID
    tmpfs:
      - /tmp:size=64m
      - /var/lib/neo4j/run:size=8m
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.3'
    healthcheck:
      test: ["CMD", "neo4j", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - docker-apps-network

  # ===========================================
  # LightRAG Service
  # ===========================================
  lightrag:
    image: ghcr.io/hkuds/lightrag:latest
    container_name: lightrag
    restart: unless-stopped
    depends_on:
      - neo4j
    environment:
      - TIKTOKEN_CACHE_DIR=/app/data/tiktoken
    volumes:
      - ./lightrag/data/rag_storage:/app/data/rag_storage
      - ./lightrag/data/inputs:/app/data/inputs
      - ./lightrag/data/tiktoken:/app/data/tiktoken
      - ./lightrag/.env:/app/.env
    expose:
      - 9621
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
    healthcheck:
      test: ["CMD-SHELL", "python3 -c 'import urllib.request; urllib.request.urlopen(\"http://127.0.0.1:9621/\")' || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.8'
        reservations:
          memory: 500M
          cpus: '0.2'
    networks:
      - docker-apps-network

  # ===========================================
  # GRAPHITI - Knowledge Graph Memory System
  # ===========================================
  graphiti:
    build:
      context: ./graphiti
      dockerfile: Dockerfile
    container_name: graphiti
    restart: unless-stopped
    depends_on:
      neo4j:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-CHANGE_ME_NEO4J_PASSWORD}
      - DATABASE__PROVIDER=neo4j
      - MODEL_NAME=${GRAPHITI_MODEL:-gpt-4o-mini}
      - GRAPHITI_GROUP_ID=${GRAPHITI_GROUP_ID:-pierre_memories}
    volumes:
      - graphiti-data:/app/data
    expose:
      - 8000
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
      - /root/.cache:size=128m
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    networks:
      - docker-apps-network

  # ===========================================
  # DeepEval LLM Evaluation API
  # ===========================================
  deepeval:
    build:
      context: ./deepeval
      dockerfile: Dockerfile
    container_name: deepeval
    restart: unless-stopped
    env_file:
      - ./deepeval/.env
    expose:
      - 8000
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
      - /app/.deepeval:size=1m
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.2'
    networks:
      - docker-apps-network

  # ===========================================
  # Qdrant Vector Database
  # ===========================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__WEB_UI__ENABLED: true
      QDRANT__LOG_LEVEL: INFO
    volumes:
      - qdrant-data:/qdrant/storage
    expose:
      - 6333
      - 6334
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
      - /qdrant/snapshots:size=64m
      - /qdrant/.qdrant-initialized:size=1m
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/127.0.0.1/6333 && echo -e \"GET /healthz HTTP/1.0\\r\\nHost: localhost\\r\\n\\r\\n\" >&3 && cat <&3 | grep -q 200'"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    networks:
      - docker-apps-network

  # ===========================================
  # Chonkie Backend API
  # ===========================================
  chonkie:
    build: ./chonkie
    container_name: chonkie
    restart: unless-stopped
    environment:
      - DEFAULT_SENTENCE_TRANSFORMER_MODEL=all-MiniLM-L6-v2
      - ENABLE_LOCAL_EMBEDDINGS=true
      - DEFAULT_EMBEDDING_PROVIDER=sentence-transformers
      - SEMANTIC_THRESHOLD=0.3
    env_file:
      - ./chonkie/.env.local
    volumes:
      - chonkie-data:/home/chonkie/data
    expose:
      - 8000
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.25'
    networks:
      - docker-apps-network

  # ===========================================
  # Chonkie Visualizer Frontend
  # ===========================================
  chonkie-visualizer:
    build:
      context: ./chonkie/chonkie-visualizer
      dockerfile: Dockerfile
    container_name: chonkie-visualizer
    restart: unless-stopped
    depends_on:
      - chonkie
    expose:
      - 3001
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
      - /app/.next/cache:size=128m,uid=1001,gid=1001
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'
    networks:
      - docker-apps-network

  # ===========================================
  # MONITORING STACK
  # ===========================================
  prometheus:
    image: prom/prometheus:v2.47.2
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.external-url=https://monitoring.brandiron.co.za/prometheus/'
      - '--web.route-prefix=/prometheus/'
    volumes:
      - ./monitoring/prometheus:/etc/prometheus
      - prometheus-data:/prometheus
    expose:
      - 9090
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:9090/prometheus/-/healthy || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.2'
        reservations:
          memory: 128M
          cpus: '0.05'
    networks:
      - docker-apps-network

  # ===========================================
  # Grafana
  # ===========================================
  grafana:
    image: grafana/grafana:11.4.0
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-CHANGE_ME_GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=monitoring.brandiron.co.za
      - GF_SERVER_ROOT_URL=https://monitoring.brandiron.co.za/
      - GF_SERVER_SERVE_FROM_SUB_PATH=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    expose:
      - 3000
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
      - /var/run:size=1m
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.2'
        reservations:
          memory: 128M
          cpus: '0.05'
    networks:
      - docker-apps-network

  # ===========================================
  # cadvisor
  # ===========================================
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.50.0
    container_name: cadvisor
    restart: unless-stopped
    privileged: true
    command:
      - '--housekeeping_interval=10s'
      - '--docker_only=false'
      - '--store_container_labels=true'
      - '--whitelisted_container_labels=com.docker.compose.service'
    devices:
      - /dev/kmsg:/dev/kmsg
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /cgroup:/cgroup:ro
    expose:
      - 8080
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.15'
        reservations:
          memory: 64M
          cpus: '0.05'
    networks:
      - docker-apps-network

  # ===========================================
  # node-exporter
  # ===========================================
  node-exporter:
    image: prom/node-exporter:v1.6.1
    container_name: node-exporter
    restart: unless-stopped
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      - '--collector.textfile.directory=/var/lib/node_exporter/textfile_collector'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
      - /var/lib/node_exporter/textfile_collector:/var/lib/node_exporter/textfile_collector:ro
    expose:
      - 9100
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=16m
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:9100/metrics || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'
    networks:
      - docker-apps-network

  # ===========================================
  # PIERRE PORTFOLIO WEBSITE
  # ===========================================
  personal-website:
    build:
      context: ./personal-website
      dockerfile: Dockerfile
    container_name: personal-website
    restart: unless-stopped
    env_file:
      - ./personal-website/.env
    expose:
      - 80
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    tmpfs:
      - /var/cache/nginx:size=32m
      - /run:size=1m
      - /tmp:size=32m
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.05'
    networks:
      - docker-apps-network

  # ===========================================
  # Reading Fluency App
  # ===========================================
  reading-fluency:
    build:
      context: ./reading-fluency
      dockerfile: Dockerfile
    container_name: reading-fluency
    restart: unless-stopped
    env_file:
      - ./reading-fluency/.env
    expose:
      - 8000
    volumes:
      - reading-fluency-logs:/app/logs
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=64m
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 600M
          cpus: '0.1'
    networks:
      - docker-apps-network

volumes:
  n8n-data:
  neo4j-data:
  neo4j-logs:
  qdrant-data:
  chonkie-data:
  prometheus-data:
  grafana-data:
  reading-fluency-logs:
  graphiti-data:

networks:
  docker-apps-network:
    driver: bridge
